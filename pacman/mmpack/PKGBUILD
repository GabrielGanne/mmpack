# Maintainer: Nicolas Bourdaud <nicolas.bourdaud@mindmaze.ch>
pkgname=("${MINGW_PACKAGE_PREFIX}-mmpack")
pkgbase=mmpack
pkgver=0.0.1
pkgrel=1
pkgdesc="MindMaze package manager
  This package provides the infrastructure for handling the build,
  installation and removal of mmpack software packages."
arch=('x86_64')
url="https://intranet.mindmaze.ch/mmlabs/gerrit/admin/projects/mmpack"
source=(git+file://${HOME}/sources/mmpack#branch=master)
sha256sums=(SKIP)

depends=(mingw-w64-x86_64-libyaml
         mingw-w64-x86_64-curl
         mingw-w64-x86_64-libarchive
         mingw-w64-x86_64-libmmlib0
)

build() {
    cd $pkgbase
    ./autogen.sh
    ./configure --prefix=/usr \
        --prefix=${MINGW_PREFIX} \
        --build=${MINGW_CHOST} \
        --host=${MINGW_CHOST}

    make
    make DESTDIR=${srcdir}/dest install
}

package_mmpack() {
    groups=('base')
    local instdir=${srcdir}/dest/${MINGW_PREFIX}

    mkdir -p ${pkgdir}/${MINGW_PREFIX}
    cp -rf ${instdir}/bin ${pkgdir}/${MINGW_PREFIX}
    cp -rf ${instdir}/libexec ${pkgdir}/${MINGW_PREFIX}

	mkdir -p {pkgdir}/${MINGW_PREFIX}/share/mmpack
	cp -rf ${instdir}/share/mmpack/check-dpkg-installed {pkgdir}/${MINGW_PREFIX}/share/mmpack/

	mkdir -p {pkgdir}/${MINGW_PREFIX}/share/man/man1
	cp -rf ${instdir}/share/man/man1/mmpack.1 {pkgdir}/${MINGW_PREFIX}/share/man/man1/
	cp -rf ${instdir}/share/man/man1/mmpack-install.1 {pkgdir}/${MINGW_PREFIX}/share/man/man1/
	cp -rf ${instdir}/share/man/man1/mmpack-mkprefix.1 {pkgdir}/${MINGW_PREFIX}/share/man/man1/
	cp -rf ${instdir}/share/man/man1/mmpack-remove.1 {pkgdir}/${MINGW_PREFIX}/share/man/man1/
	cp -rf ${instdir}/share/man/man1/mmpack-runprefix.1 {pkgdir}/${MINGW_PREFIX}/share/man/man1/
	cp -rf ${instdir}/share/man/man1/mmpack-search.1 {pkgdir}/${MINGW_PREFIX}/share/man/man1/
	cp -rf ${instdir}/share/man/man1/mmpack-update.1 {pkgdir}/${MINGW_PREFIX}/share/man/man1/

	mkdir -p ${pkgdir}/${MINGW_PREFIX}/share/bash-completion/completions/
    cp -rf ${instdir}/share/bash-completion/completions/mmpack_completion ${pkgdir}/${MINGW_PREFIX}/share/bash-completion/completions/
}

eval "package_${MINGW_PACKAGE_PREFIX}-mmpack() { package_mmpack; }"
